#!/usr/bin/env bash
# zf - A smart and fast directory jumper
# Combines zoxide history with live fd scans.

zf() {
  # current dir and HOME dir are included by default
  local extra_dirs=(
    /usr/local /etc /opt /var/log /var/www /var/lib /srv /mnt /media
  )

  local fd_ignores=(
    .git node_modules .cache .venv .vscode __pycache__ .DS_Store
    .idea .mypy_cache .pytest_cache .next dist build target .gradle
    .terraform .egg-info .env .history .svn .hg .Trash .local/share/Trash
  )

  local fd_excludes=()
  for pat in "${fd_ignores[@]}"; do
    fd_excludes+=(--exclude "$pat")
  done

  selected_output=$(
    {
      # sources in order of priority:
      zoxide query --list
      # dirs which are not in extra_dirs
      fd -t d --hidden -d 10 "${fd_excludes[@]}" . . ~ 2>/dev/null
      fd -t d -d 8 "${fd_excludes[@]}" . "${extra_dirs[@]}" 2>/dev/null
      fd -t d -d 1 "${fd_excludes[@]}" . / 2>/dev/null
    } |
      sed "s|^$HOME|~|" |
      fzf --height 50% --layout reverse --info=inline \
        --scheme=path --query "'" --no-sort \
        --cycle --ansi --preview-window 'right:30%' \
        --preview 'eza --color always --oneline "$(echo {} | sed "s|^~|$HOME|")"'
  )

  if [[ -n "$selected_output" ]]; then
    local target_dir="${selected_output//\~/$HOME}"
    cd "$target_dir" || exit
  fi
}
