#!/usr/bin/env bash

ACTIVE_WINDOW=$(hyprctl activewindow -j 2>/dev/null)
if [ -z "$ACTIVE_WINDOW" ] || [ "$ACTIVE_WINDOW" = "null" ]; then
  exit 1
fi

CLASS=$(echo "$ACTIVE_WINDOW" | jq -r '.class // empty')
TITLE=$(echo "$ACTIVE_WINDOW" | jq -r '.title // empty')
FOOT_PID=$(echo "$ACTIVE_WINDOW" | jq -r '.pid // empty')

if [[ "$CLASS" != "foot" && "$CLASS" != "footclient" ]]; then
  exit 1
fi

check_pid() {
  local pid=$1
  
  SESSION=$(tmux list-clients -F '#{client_pid} #{client_session}' 2>/dev/null |
    awk -v pid="$pid" '$1 == pid {print $2}')

  if [[ -n "$SESSION" ]]; then
    ACTIVE_PANE=$(tmux display-message -t "$SESSION" -p '#{pane_id}')
    TITLE=$(tmux display-message -t "$SESSION" -p '#T')
    echo "Client PID: $pid"
    echo "Session: $SESSION"
    echo "Active Pane: $ACTIVE_PANE"
    echo "Title: $TITLE"
    exit 0
  fi
}

find_tmux_client() {
  local pid=$1
  local is_root=$2
  
  if [[ "$is_root" != "true" ]]; then
    check_pid "$pid"
  fi
  
  local children=$(pgrep -P "$pid" 2>/dev/null)
  for child in $children; do
    find_tmux_client "$child" "false"
  done
}

find_tmux_client "$FOOT_PID" "true"

echo "No active tmux pane found in focused foot window"
exit 1
